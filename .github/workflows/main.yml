name: Band Auto Posting

on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  schedule:
    - cron: '0 */1 * * *'  # ë§¤ ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰

jobs:
  post:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y unzip shadowsocks-libev
        pip install selenium requests beautifulsoup4 webdriver_manager
        
    - name: Setup VPN
      run: |
        echo '{
          "server":"34.64.189.76",
          "server_port":16978,
          "password":"Nsy5l8wxxzHg4CXPKwEw6S",
          "method":"chacha20-ietf-poly1305",
          "local_address":"127.0.0.1",
          "local_port":1080
        }' > ss-config.json
        ss-local -c ss-config.json -v &
        sleep 5
        curl --socks5 127.0.0.1:1080 http://ip-api.com/json
        
    - name: Setup Chrome
      uses: browser-actions/setup-chrome@latest
      
    - name: Check Directory Structure
      run: |
        pwd
        echo "í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬ êµ¬ì¡°:"
        ls -la
        
    - name: Extract Chrome Profile
      run: |
        echo "Chrome í”„ë¡œí•„ ì••ì¶• í•´ì œ ì¤‘..."
        mkdir -p chrome-profile
        unzip -o "chrome_profile.zip" -d ./chrome-profile || {
          echo "chrome_profile.zip íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          echo "í˜„ì¬ í´ë” ë‚´ìš©:"
          ls -la
          exit 1
        }
        echo "Chrome í”„ë¡œí•„ ì••ì¶• í•´ì œ ì™„ë£Œ"
        
    - name: Run Auto Posting
      run: |
        echo "=== ë°´ë“œ ìë™ í¬ìŠ¤íŒ… ì‹œì‘ ==="
        
        # ë¡œê·¸ íŒŒì¼ ì´ˆê¸°í™”
        echo "ì‘ì—… ì‹œì‘ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')" > band_auto.log
        
        # ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ìŠ¤í¬ë¦½íŠ¸
        PYTHONUNBUFFERED=1 python auto_band_action.py 2>&1 | while IFS= read -r line; do
          timestamp=$(date '+%Y-%m-%d %H:%M:%S')
          
          # ìƒì„¸í•œ ë‹¨ê³„ë³„ ì§„í–‰ ìƒí™© ëª¨ë‹ˆí„°ë§
          case "$line" in
            *"VPN ìƒíƒœ"*|*"í˜„ì¬ IP"*|*"êµ­ê°€"*|*"ISP"*)
              echo "========== VPN ì—°ê²° ìƒíƒœ =========="
              echo "[$timestamp] $line"
              echo "==================================="
              ;;
              
            *"Chrome driver"*|*"Driver setup"*)
              echo "========= ë“œë¼ì´ë²„ ì´ˆê¸°í™” ========="
              echo "[$timestamp] $line"
              echo "==================================="
              ;;
              
            *"ë¡œê·¸ì¸ ì‹œì‘"*|*"ë¡œê·¸ì¸ í˜ì´ì§€"*)
              echo "ğŸ” ====== ë¡œê·¸ì¸ í”„ë¡œì„¸ìŠ¤ ì‹œì‘ ======"
              echo "[$timestamp] $line"
              ;;
              
            *"ì´ë©”ì¼ ì…ë ¥"*)
              echo "âœ‰ï¸ ì´ë©”ì¼ ì…ë ¥ ë‹¨ê³„"
              echo "[$timestamp] $line"
              ;;
              
            *"ë¹„ë°€ë²ˆí˜¸ ì…ë ¥"*)
              echo "ğŸ”‘ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ë‹¨ê³„"
              echo "[$timestamp] $line"
              ;;
              
            *"ë¡œê·¸ì¸ ì„±ê³µ"*)
              echo "âœ… ë¡œê·¸ì¸ ì™„ë£Œ"
              echo "[$timestamp] $line"
              echo "===================================="
              ;;
              
            *"í˜„ì¬ ì‘ì—… ì¤‘ì¸ URL"*)
              echo "ğŸ”— ======= URL ì‘ì—… ì •ë³´ ========"
              echo "[$timestamp] $line"
              ;;
              
            *"ë°´ë“œë¡œ ì´ë™"*|*"URL ì£¼ì†Œ:"*)
              echo "ğŸŒ í˜„ì¬ í˜ì´ì§€ ì´ë™"
              echo "[$timestamp] $line"
              ;;
              
            *"ê¸€ì“°ê¸° ë²„íŠ¼"*)
              echo "ğŸ“ í¬ìŠ¤íŒ… ì‘ì„± ì‹œì‘"
              echo "[$timestamp] $line"
              ;;
              
            *"URL ì…ë ¥ ì¤‘"*)
              echo "âŒ¨ï¸ URL ì…ë ¥"
              echo "[$timestamp] $line"
              ;;
              
            *"ë¯¸ë¦¬ë³´ê¸° ë¡œë”©"*)
              echo "â³ ë¯¸ë¦¬ë³´ê¸° ë¡œë”©"
              echo "[$timestamp] $line"
              ;;
              
            *"í¬ìŠ¤íŒ… ì™„ë£Œ"*)
              echo "âœ… ======= í¬ìŠ¤íŒ… ì™„ë£Œ ========"
              echo "[$timestamp] $line"
              echo "================================"
              ;;
              
            *"ì‹¤íŒ¨"*|*"ì˜¤ë¥˜"*)
              echo "âŒ ======= ì˜¤ë¥˜ ë°œìƒ ========"
              echo "[$timestamp] $line"
              echo "=============================="
              ;;
              
            *"ëŒ€ê¸° ì‹œì‘"*|*"ë‚¨ì€ ì‹œê°„"*)
              echo "â° ëŒ€ê¸° ìƒíƒœ"
              echo "[$timestamp] $line"
              ;;
              
            *)
              echo "[$timestamp] $line"
              ;;
          esac
          
          # ë¡œê·¸ íŒŒì¼ì—ë„ ì €ì¥
          echo "[$timestamp] $line" >> band_auto.log
          
        done

        echo -e "\n=== ì‹¤í–‰ í†µê³„ ìƒì„± ==="
        {
          echo "1. ë¡œê·¸ì¸ í”„ë¡œì„¸ìŠ¤"
          echo "- ì‹œë„ íšŸìˆ˜: $(grep -c "ë¡œê·¸ì¸ ì‹œì‘" band_auto.log)"
          echo "- ì„±ê³µ íšŸìˆ˜: $(grep -c "ë¡œê·¸ì¸ ì„±ê³µ" band_auto.log)"
          
          echo -e "\n2. URL ì‘ì—… í˜„í™©"
          echo "- ì²˜ë¦¬ëœ URL ìˆ˜: $(grep -c "í˜„ì¬ ì‘ì—… ì¤‘ì¸ URL" band_auto.log)"
          echo "- í˜ì´ì§€ ì´ë™ ìˆ˜: $(grep -c "ë°´ë“œë¡œ ì´ë™" band_auto.log)"
          
          echo -e "\n3. í¬ìŠ¤íŒ… í†µê³„"
          echo "- ê¸€ì“°ê¸° ì‹œë„: $(grep -c "ê¸€ì“°ê¸° ë²„íŠ¼" band_auto.log)"
          echo "- í¬ìŠ¤íŒ… ì„±ê³µ: $(grep -c "í¬ìŠ¤íŒ… ì™„ë£Œ" band_auto.log)"
          echo "- ì‹¤íŒ¨/ì˜¤ë¥˜: $(grep -c "ì‹¤íŒ¨\|ì˜¤ë¥˜" band_auto.log)"
          
          echo -e "\n4. ìƒì„¸ URL ê¸°ë¡"
          echo "ì²˜ë¦¬ëœ URL ëª©ë¡:"
          grep "URL ì£¼ì†Œ:" band_auto.log
          
          echo -e "\n5. ë§ˆì§€ë§‰ ì‘ì—… ìƒíƒœ"
          tail -n 20 band_auto.log
          
        } | tee execution_summary.txt

      env:
        CHROME_PROFILE_PATH: "./chrome-profile"
        ALL_PROXY: "socks5://127.0.0.1:1080"
        PYTHONUNBUFFERED: 1
        TZ: 'Asia/Seoul'
