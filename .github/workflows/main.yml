name: Band Auto Posting

on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  schedule:
    - cron: '0 */1 * * *'  # ë§¤ ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰

jobs:
  post:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y unzip shadowsocks-libev
        pip install selenium requests beautifulsoup4 webdriver_manager
        
    - name: Setup VPN
      run: |
        echo '{
          "server":"34.64.189.76",
          "server_port":16978,
          "password":"Nsy5l8wxxzHg4CXPKwEw6S",
          "method":"chacha20-ietf-poly1305",
          "local_address":"127.0.0.1",
          "local_port":1080
        }' > ss-config.json
        ss-local -c ss-config.json -v &
        sleep 5
        curl --socks5 127.0.0.1:1080 http://ip-api.com/json
        
    - name: Setup Chrome
      uses: browser-actions/setup-chrome@latest

    - name: Check Chrome and Chromedriver Version
      run: |
        # Chrome ë²„ì „ í™•ì¸ (ì˜¤ë¥˜ ì²˜ë¦¬ ì¶”ê°€)
        if ! chrome_version=$(google-chrome --version 2>/dev/null); then
          echo "Chrome ë²„ì „ í™•ì¸ ì‹¤íŒ¨, ë‹¤ë¥¸ ë°©ë²• ì‹œë„..."
          chrome_version=$(google-chrome-stable --version 2>/dev/null || chromium-browser --version 2>/dev/null)
        fi
        
        if [ -z "$chrome_version" ]; then
          echo "Chrome ë²„ì „ì„ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          exit 1
        fi
        
        echo "ê°ì§€ëœ Chrome ë²„ì „: $chrome_version"
        CHROME_VERSION=$(echo "$chrome_version" | awk '{print $NF}' | cut -d'.' -f1)
        echo "ì¶”ì¶œëœ ë©”ì´ì € ë²„ì „: $CHROME_VERSION"

    - name: Install Compatible Chromedriver
      run: |
        if [ -z "$CHROME_VERSION" ]; then
          echo "Chrome ë²„ì „ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ ìµœì‹  ë²„ì „ì˜ Chromedriverë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤."
          CHROMEDRIVER_VERSION=$(wget -qO- https://chromedriver.storage.googleapis.com/LATEST_RELEASE)
        else
          CHROMEDRIVER_VERSION=$(wget -qO- "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_${CHROME_VERSION}")
        fi
        
        echo "Chromedriver ë²„ì „: $CHROMEDRIVER_VERSION"
        wget -q "https://chromedriver.storage.googleapis.com/${CHROMEDRIVER_VERSION}/chromedriver_linux64.zip"
        
        if [ ! -f "chromedriver_linux64.zip" ]; then
          echo "Chromedriver ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨"
          exit 1
        fi
        
        unzip -o chromedriver_linux64.zip
        sudo mv chromedriver /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver
        rm chromedriver_linux64.zip

    - name: Download Chrome Profile
      run: |
        echo "Chrome í”„ë¡œí•„ ë‹¤ìš´ë¡œë“œ ì¤‘..."
        wget https://github.com/sd2624/qqqq071026242/raw/master/chrome_profile.zip -O chrome_profile.zip
        
        if [ ! -f "chrome_profile.zip" ]; then
          echo "í”„ë¡œí•„ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨"
          exit 1
        fi
        
        echo "í”„ë¡œí•„ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ"
        ls -la chrome_profile.zip
        
    - name: Check Profile Archive
      run: |
        if [ ! -f "chrome_profile.zip" ]; then
          echo "chrome_profile.zip not found!"
          exit 1
        fi
        echo "Found chrome_profile.zip"
        
    - name: Clean Chrome Processes
      run: |
        # ê¸°ì¡´ Chrome í”„ë¡œì„¸ìŠ¤ ê°•ì œ ì¢…ë£Œ
        echo "ê¸°ì¡´ Chrome í”„ë¡œì„¸ìŠ¤ ì •ë¦¬ ì¤‘..."
        pgrep -x "chrome" && pkill -9 "chrome"
        pgrep -x "chromedriver" && pkill -9 "chromedriver"
        sleep 2

    - name: Kill existing Chrome processes
      run: pkill -9 chrome || true
      
    - name: Extract Chrome Profile
      run: |
        unzip chrome_profile.zip -d chrome-profile
        chmod -R 777 chrome-profile
        echo "CHROME_PROFILE_DIR=$(pwd)/chrome-profile" >> $GITHUB_ENV
        ls -la chrome-profile/Default/

    - name: Start Xvfb
      run: Xvfb :99 -screen 0 1920x1080x24 &

    - name: Set Display
      run: echo "DISPLAY=:99" >> $GITHUB_ENV

    - name: Setup Chrome Profile
      run: |
        # í”„ë¡œí•„ ë””ë ‰í† ë¦¬ ì„¤ì •
        PROFILE_DIR="/tmp/chrome-profile-$GITHUB_RUN_ID"
        echo "í”„ë¡œí•„ ë””ë ‰í† ë¦¬: $PROFILE_DIR"
        
        # ê¸°ì¡´ í”„ë¡œí•„ ì •ë¦¬ ë° ì´ˆê¸° ì„¤ì •
        sudo rm -rf "$PROFILE_DIR"
        mkdir -p "$PROFILE_DIR/Default"
        
        # í”„ë¡œí•„ ë‹¤ìš´ë¡œë“œ ë° ì••ì¶• í•´ì œ
        echo "í”„ë¡œí•„ ë‹¤ìš´ë¡œë“œ ì¤‘..."
        wget -q https://github.com/sd2624/qqqq071026242/raw/master/chrome_profile.zip
        
        if [ ! -f "chrome_profile.zip" ]; then
          echo "í”„ë¡œí•„ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨"
          exit 1
        fi
        
        unzip -o chrome_profile.zip -d "$PROFILE_DIR"
        
        # ê¶Œí•œ ë° ì†Œìœ ê¶Œ ì„¤ì •
        sudo chown -R $USER:$USER "$PROFILE_DIR"
        chmod -R 755 "$PROFILE_DIR"
        
        # ìºì‹œ ì´ˆê¸°í™”
        rm -rf "$PROFILE_DIR/Default/Cache"/*
        mkdir -p "$PROFILE_DIR/Default/Cache"
        
        # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        echo "CHROME_PROFILE_DIR=$PROFILE_DIR" >> $GITHUB_ENV
        echo "CHROME_BIN=/usr/bin/google-chrome-stable" >> $GITHUB_ENV
        
        # í”„ë¡œí•„ êµ¬ì¡° í™•ì¸
        echo "í”„ë¡œí•„ êµ¬ì¡° í™•ì¸:"
        ls -la "$PROFILE_DIR/Default/"
        
        # Chrome ì´ˆê¸° ì‹¤í–‰ (ì‹¤í–‰ ì˜µì…˜ë§Œ ì—¬ê¸°ì„œ --no-sandbox ì‚¬ìš©)
        echo "Chrome ì´ˆê¸° ì‹¤í–‰ í…ŒìŠ¤íŠ¸..."
        "$CHROME_BIN" \
          --no-sandbox \
          --user-data-dir="$PROFILE_DIR" \
          --headless \
          --disable-gpu \
          --remote-debugging-port=9222 \
          --disable-dev-shm-usage \
          about:blank

    - name: Setup Chrome Profile
      run: |
        # í”„ë¡œí•„ ë””ë ‰í† ë¦¬ ì„¤ì •
        PROFILE_DIR="${CHROME_PROFILE_DIR}"
        echo "í”„ë¡œí•„ ë””ë ‰í† ë¦¬: $PROFILE_DIR"
        
        # ìºì‹œ ë””ë ‰í† ë¦¬ ì´ˆê¸°í™”
        rm -rf "$PROFILE_DIR/Default/Cache"/*
        mkdir -p "$PROFILE_DIR/Default/Cache"
        
        # í•„ìˆ˜ ë””ë ‰í† ë¦¬ ìƒì„±
        for dir in "Local Storage" "Session Storage" "Network"; do
          mkdir -p "$PROFILE_DIR/Default/$dir"
          chmod 755 "$PROFILE_DIR/Default/$dir"
        done
        
        # í”„ë¡œí•„ êµ¬ì¡° í™•ì¸
        echo "í”„ë¡œí•„ êµ¬ì¡° í™•ì¸:"
        ls -la "$PROFILE_DIR/Default/"

    - name: Setup Chrome Profile
      run: |
        # í”„ë¡œí•„ ë””ë ‰í† ë¦¬ ì„¤ì •
        PROFILE_DIR="/tmp/chrome-profile-$GITHUB_RUN_ID"
        echo "í”„ë¡œí•„ ë””ë ‰í† ë¦¬: $PROFILE_DIR"
        
        # ê¸°ì¡´ í”„ë¡œí•„ ì™„ì „ ì œê±°
        sudo rm -rf "$PROFILE_DIR"
        mkdir -p "$PROFILE_DIR/Default"
        
        # GitHubì—ì„œ í”„ë¡œí•„ ë‹¤ìš´ë¡œë“œ
        echo "í”„ë¡œí•„ ë‹¤ìš´ë¡œë“œ ì¤‘..."
        wget -q https://github.com/sd2624/qqqq071026242/raw/master/chrome_profile.zip
        
        if [ ! -f "chrome_profile.zip" ]; then
          echo "í”„ë¡œí•„ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨"
          exit 1
        fi
        
        # í”„ë¡œí•„ ì••ì¶• í•´ì œ
        unzip -o chrome_profile.zip -d "$PROFILE_DIR"
        
        # ê¶Œí•œ ì„¤ì •
        sudo chown -R $USER:$USER "$PROFILE_DIR"
        chmod -R 755 "$PROFILE_DIR"
        
        # ìºì‹œ ë””ë ‰í† ë¦¬ ì´ˆê¸°í™”
        rm -rf "$PROFILE_DIR/Default/Cache"/*
        mkdir -p "$PROFILE_DIR/Default/Cache"
        
        echo "CHROME_PROFILE_DIR=$PROFILE_DIR" >> $GITHUB_ENV
        
        # í”„ë¡œí•„ ì„¤ì • í™•ì¸
        echo "í”„ë¡œí•„ êµ¬ì¡° í™•ì¸:"
        ls -la "$PROFILE_DIR/Default/"

    - name: Check Directory Structure
      run: |
        pwd
        echo "í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬ êµ¬ì¡°:"
        ls -la

    - name: Run Auto Posting
      env:
        CHROME_PROFILE_PATH: ${CHROME_PROFILE_DIR}
        XDG_CONFIG_HOME: ${CHROME_PROFILE_DIR}
        DISPLAY: :99
        ALL_PROXY: "socks5://127.0.0.1:1080"
        CHROME_REMOTE_DEBUGGING_PORT: "9222"
        PYTHONUNBUFFERED: 1
        TZ: "Asia/Seoul"
      run: |
        export CHROME_OPTIONS="
          --user-data-dir=${CHROME_PROFILE_DIR}
          --profile-directory=Default
          --no-sandbox
          --disable-dev-shm-usage
          --password-store=basic
          --disable-gpu
          --disable-software-rasterizer
        "
        
        # Chrome ì˜µì…˜ ìµœì†Œí™”
        export CHROME_OPTIONS="
          --user-data-dir=${CHROME_PROFILE_DIR}
          --profile-directory=Default
          --no-sandbox
          --disable-dev-shm-usage
          --disable-gpu
          --password-store=basic
          --disable-background-networking
          --disable-default-apps
          --disable-sync
          --no-first-run
        "
        
        # í”„ë¡œí•„ ë””ë²„ê·¸
        echo "Chrome í”„ë¡œí•„ ìœ„ì¹˜: ${CHROME_PROFILE_DIR}"
        ls -la ${CHROME_PROFILE_DIR}/Default/
        
        echo -e "\n\033[1;36m=== ë°´ë“œ ìë™ í¬ìŠ¤íŒ… ì‹œì‘ ===\033[0m"
        echo -e "\033[1;33mí˜„ì¬ ì‹œê°: $(date '+%Y-%m-%d %H:%M:%S')\033[0m"
        echo -e "\033[1;36m======================================\033[0m\n"
        
        # ë¡œê·¸ íŒŒì¼ ì´ˆê¸°í™” ë° ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§
        {
          echo "ì‘ì—… ì‹œì‘ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "======================================="
          echo "1ë‹¨ê³„: ë¡œê·¸ì¸ í”„ë¡œì„¸ìŠ¤ ì‹œì‘"
          echo "======================================="
        } > band_auto.log
        
        # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ë° ì‹¤ì‹œê°„ ë¡œê·¸ ì¶œë ¥
        PYTHONUNBUFFERED=1 python auto_band_action.py 2>&1 | while IFS= read -r line; do
          timestamp=$(date '+%Y-%m-%d %H:%M:%S')
          
          # ë¡œê·¸ì¸ ê´€ë ¨ ë©”ì‹œì§€ ìš°ì„  ì²˜ë¦¬
          case "$line" in
            *"driver.get("*|*"ì´ë™:"*|*"URL:"*)
              echo -e "\n\033[1;35mğŸŒ í˜ì´ì§€ ì´ë™\033[0m"
              echo "[$timestamp] í˜„ì¬ URL: ${line#*\'}"  # URL ë¶€ë¶„ë§Œ ì¶”ì¶œ
              echo "----------------------------------------"
              ;;
              
            *"ë°´ë“œë¡œ ì´ë™"*|*"URL ì£¼ì†Œ:"*)
              echo -e "\n\033[1;36mğŸ”„ í˜ì´ì§€ ì „í™˜\033[0m"
              echo "[$timestamp] $line"
              echo "í˜„ì¬ ì‘ì—…: ë°´ë“œ í˜ì´ì§€ ë¡œë”©"
              echo "----------------------------------------"
              ;;
              
            *"ë¡œê·¸ì¸ ì‹œì‘"*|*"ë¡œê·¸ì¸ ì‹œë„"*)
              echo -e "\n\033[1;34mğŸ” ë¡œê·¸ì¸ í”„ë¡œì„¸ìŠ¤ ì‹œì‘\033[0m"
              echo "[$timestamp] $line"
              ;;
            
            *"ì´ë©”ì¼ ì…ë ¥"*|*"ë¹„ë°€ë²ˆí˜¸ ì…ë ¥"*)
              echo -e "\033[1;33mâŒ¨ï¸  $line\033[0m"
              echo "[$timestamp] $line"
              ;;
            
            *"ë¡œê·¸ì¸ ì„±ê³µ"*)
              echo -e "\033[1;32mâœ… ë¡œê·¸ì¸ ì„±ê³µ!\033[0m"
              echo "[$timestamp] $line"
              echo "----------------------------------------"
              ;;
              
            *"VPN ìƒíƒœ"*|*"í˜„ì¬ IP"*)
              echo -e "\033[1;36mğŸŒ $line\033[0m"
              echo "[$timestamp] $line"
              ;;
              
            *"ë¡œê·¸ì¸ ì‹œì‘"*)
              echo ""
              echo "ğŸ”µ ========= ë¡œê·¸ì¸ í”„ë¡œì„¸ìŠ¤ ì‹œì‘ ========="
              echo "[$timestamp] $line"
              echo "í˜„ì¬ ë‹¨ê³„: ë¡œê·¸ì¸ í˜ì´ì§€ ì ‘ì† ì‹œë„"
              ;;
              
            *"ë¡œê·¸ì¸ í˜ì´ì§€ ì´ë™"*)
              echo "[$timestamp] âœ“ ë¡œê·¸ì¸ í˜ì´ì§€ ì ‘ì† ì™„ë£Œ"
              echo "í˜„ì¬ ë‹¨ê³„: ì´ë©”ì¼ ë¡œê·¸ì¸ ë²„íŠ¼ ì°¾ëŠ” ì¤‘"
              ;;
              
            *"ì´ë©”ì¼ ë¡œê·¸ì¸ ë²„íŠ¼"*)
              echo "[$timestamp] âœ“ ì´ë©”ì¼ ë¡œê·¸ì¸ ë²„íŠ¼ ë°œê²¬"
              echo "í˜„ì¬ ë‹¨ê³„: ì´ë©”ì¼ ì…ë ¥ ì¤€ë¹„"
              ;;
              
            *"ì´ë©”ì¼ ì…ë ¥ ì™„ë£Œ"*)
              echo "[$timestamp] âœ“ ì´ë©”ì¼ ì…ë ¥ ì™„ë£Œ"
              echo "í˜„ì¬ ë‹¨ê³„: ë‹¤ìŒ ë²„íŠ¼ í´ë¦­"
              ;;
              
            *"ë‹¤ìŒ ë²„íŠ¼ í´ë¦­"*)
              echo "[$timestamp] âœ“ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™"
              echo "í˜„ì¬ ë‹¨ê³„: ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì¤€ë¹„"
              ;;
              
            *"ë¹„ë°€ë²ˆí˜¸ ì…ë ¥"*)
              echo "[$timestamp] ğŸ”‘ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì¤‘..."
              ;;
              
            *"ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì™„ë£Œ"*)
              echo "[$timestamp] âœ“ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì™„ë£Œ"
              echo "í˜„ì¬ ë‹¨ê³„: ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­"
              ;;
              
            *"ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­"*)
              echo "[$timestamp] ğŸ”„ ë¡œê·¸ì¸ ì‹œë„ ì¤‘..."
              ;;
              
            *"ë¡œê·¸ì¸ ì„±ê³µ"*)
              echo "[$timestamp] âœ… ë¡œê·¸ì¸ ì„±ê³µ!"
              echo "========= ë¡œê·¸ì¸ í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ ========="
              echo ""
              ;;
              
            *"ë¡œê·¸ì¸ ì‹¤íŒ¨"*|*"ì˜¤ë¥˜"*)
              echo "[$timestamp] âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨!"
              echo "ì—ëŸ¬ ë‚´ìš©: $line"
              echo "========= ë¡œê·¸ì¸ í”„ë¡œì„¸ìŠ¤ ì‹¤íŒ¨ ========="
              echo ""
              ;;
              
            *"í˜„ì¬ ì‘ì—… ì¤‘ì¸ URL"*)
              echo "ğŸ”— ======= URL ì‘ì—… ì •ë³´ ========"
              echo "[$timestamp] $line"
              ;;
              
            *"ë°´ë“œë¡œ ì´ë™"*|*"URL ì£¼ì†Œ:"*)
              echo "ğŸŒ í˜„ì¬ í˜ì´ì§€ ì´ë™"
              echo "[$timestamp] $line"
              ;;
              
            *"ê¸€ì“°ê¸° ë²„íŠ¼"*)
              echo "ğŸ“ í¬ìŠ¤íŒ… ì‘ì„± ì‹œì‘"
              echo "[$timestamp] $line"
              ;;
              
            *"URL ì…ë ¥ ì¤‘"*)
              echo "âŒ¨ï¸ URL ì…ë ¥"
              echo "[$timestamp] $line"
              ;;
              
            *"ë¯¸ë¦¬ë³´ê¸° ë¡œë”©"*)
              echo "â³ ë¯¸ë¦¬ë³´ê¸° ë¡œë”©"
              echo "[$timestamp] $line"
              ;;
              
            *"í¬ìŠ¤íŒ… ì™„ë£Œ"*)
              echo "âœ… ======= í¬ìŠ¤íŒ… ì™„ë£Œ ========"
              echo "[$timestamp] $line"
              echo "================================"
              ;;
              
            *"ì‹¤íŒ¨"*|*"ì˜¤ë¥˜"*)
              echo "âŒ ======= ì˜¤ë¥˜ ë°œìƒ ========"
              echo "[$timestamp] $line"
              echo "=============================="
              ;;
              
            *"ëŒ€ê¸° ì‹œì‘"*|*"ë‚¨ì€ ì‹œê°„"*)
              echo "â° ëŒ€ê¸° ìƒíƒœ"
              echo "[$timestamp] $line"
              ;;
              
            *)
              echo "[$timestamp] $line"
              ;;
          esac
          
          # URL íŒ¨í„´ ê°ì§€ ë° ë¡œê¹…
          if [[ "$line" =~ https?:// ]]; then
            echo -e "\033[1;34mğŸ”— ì ‘ì† URL: $line\033[0m"
          fi
          
          echo "[$timestamp] $line" >> band_auto.log
          
        done

        echo -e "\n=== ì‹¤í–‰ í†µê³„ ìƒì„± ==="
        {
          echo "1. ë¡œê·¸ì¸ í”„ë¡œì„¸ìŠ¤"
          echo "- ì‹œë„ íšŸìˆ˜: $(grep -c "ë¡œê·¸ì¸ ì‹œì‘" band_auto.log)"
          echo "- ì„±ê³µ íšŸìˆ˜: $(grep -c "ë¡œê·¸ì¸ ì„±ê³µ" band_auto.log)"
          
          echo -e "\n2. URL ì‘ì—… í˜„í™©"
          echo "- ì²˜ë¦¬ëœ URL ìˆ˜: $(grep -c "í˜„ì¬ ì‘ì—… ì¤‘ì¸ URL" band_auto.log)"
          echo "- í˜ì´ì§€ ì´ë™ ìˆ˜: $(grep -c "ë°´ë“œë¡œ ì´ë™" band_auto.log)"
          
          echo -e "\n3. í¬ìŠ¤íŒ… í†µê³„"
          echo "- ê¸€ì“°ê¸° ì‹œë„: $(grep -c "ê¸€ì“°ê¸° ë²„íŠ¼" band_auto.log)"
          echo "- í¬ìŠ¤íŒ… ì„±ê³µ: $(grep -c "í¬ìŠ¤íŒ… ì™„ë£Œ" band_auto.log)"
          echo "- ì‹¤íŒ¨/ì˜¤ë¥˜: $(grep -c "ì‹¤íŒ¨\|ì˜¤ë¥˜" band_auto.log)"
          
          echo -e "\n4. ìƒì„¸ URL ê¸°ë¡"
          echo "ì²˜ë¦¬ëœ URL ëª©ë¡:"
          grep "URL ì£¼ì†Œ:" band_auto.log
          
          echo -e "\n5. ë§ˆì§€ë§‰ ì‘ì—… ìƒíƒœ"
          tail -n 20 band_auto.log
          
        } | tee execution_summary.txt

