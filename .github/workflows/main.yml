name: Band Auto Posting

on:
  workflow_dispatch:  # 수동 실행 가능
  schedule:
    - cron: '0 */1 * * *'  # 매 시간마다 실행

jobs:
  post:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y unzip shadowsocks-libev
        pip install selenium requests beautifulsoup4 webdriver_manager
        
    - name: Setup VPN
      run: |
        echo '{
          "server":"34.64.189.76",
          "server_port":16978,
          "password":"Nsy5l8wxxzHg4CXPKwEw6S",
          "method":"chacha20-ietf-poly1305",
          "local_address":"127.0.0.1",
          "local_port":1080
        }' > ss-config.json
        ss-local -c ss-config.json -v &
        sleep 5
        curl --socks5 127.0.0.1:1080 http://ip-api.com/json
        
    - name: Setup Chrome
      uses: browser-actions/setup-chrome@latest
      
    - name: Check Directory Structure
      run: |
        pwd
        echo "현재 작업 디렉토리 구조:"
        ls -la
        
    - name: Extract Chrome Profile
      run: |
        echo "Chrome 프로필 압축 해제 중..."
        mkdir -p chrome-profile
        unzip -o "chrome_profile.zip" -d ./chrome-profile || {
          echo "chrome_profile.zip 파일을 찾을 수 없습니다."
          echo "현재 폴더 내용:"
          ls -la
          exit 1
        }
        echo "Chrome 프로필 압축 해제 완료"
        
    - name: Run Auto Posting
      run: |
        echo "=== 밴드 자동 포스팅 시작 ==="
        
        echo "1. VPN 상태 확인"
        IP_INFO=$(curl --socks5 127.0.0.1:1080 http://ip-api.com/json)
        echo "현재 IP 정보:"
        echo "$IP_INFO" | python3 -m json.tool
        
        echo -e "\n2. 로그인 프로세스 시작"
        python3 - <<EOF
        import json, time, datetime
        def log(msg):
            now = datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            print(f"[{now}] {msg}")
            
        with open('config.json', 'r') as f:
            config = json.load(f)
        
        log("=== 로그인 정보 ===")
        log(f"이메일: {config['email']}")
        log(f"비밀번호: {'*' * len(config['password'])}")
        EOF
        
        echo -e "\n3. 자동화 실행 로그"
        {
          PYTHONUNBUFFERED=1 python auto_band_action.py 2>&1 | while IFS= read -r line; do
            timestamp=$(date '+%Y-%m-%d %H:%M:%S')
            
            # URL 패턴 강조
            if [[ $line == *"http"* ]]; then
              echo "============ 페이지 이동 ============"
              echo "[$timestamp] $line"
              echo "===================================="
              
            # 로그인 단계 강조
            elif [[ $line == *"로그인"* ]] || [[ $line == *"이메일"* ]] || [[ $line == *"비밀번호"* ]]; then
              echo "============ 로그인 단계 ============"
              echo "[$timestamp] $line"
              echo "===================================="
              
            # 밴드 이동 강조
            elif [[ $line == *"밴드 이동"* ]] || [[ $line == *"밴드:"* ]]; then
              echo "============ 밴드 작업 ============="
              echo "[$timestamp] $line"
              echo "===================================="
              
            # 포스팅 작업 강조
            elif [[ $line == *"포스팅"* ]] || [[ $line == *"게시"* ]]; then
              echo "============ 포스팅 작업 ==========="
              echo "[$timestamp] $line"
              echo "===================================="
              
            # 일반 로그
            else
              echo "[$timestamp] $line"
            fi
          done
          
          # 실행 결과 저장
          echo -e "\n=== 실행 통계 ==="
          echo "성공한 포스팅: $(grep -c "포스팅 완료" band_auto.log)"
          echo "실패한 시도: $(grep -c "실패" band_auto.log)"
          echo "총 페이지 이동: $(grep -c "http" band_auto.log)"
          
          # 마지막 상태 표시
          echo -e "\n=== 마지막 작업 상태 ==="
          tail -n 20 band_auto.log
        }
        
        echo -e "\n=== 주요 접속 기록 ==="
        grep -E "http|페이지 이동|현재 URL" band_auto.log || echo "접속 기록 없음"
      env:
        CHROME_PROFILE_PATH: "./chrome-profile"
        ALL_PROXY: "socks5://127.0.0.1:1080"
        PYTHONUNBUFFERED: 1
        TZ: 'Asia/Seoul'  # 한국 시간으로 설정
