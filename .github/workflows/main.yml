name: Band Auto Posting

on:
  workflow_dispatch:  # 수동 실행 가능
  schedule:
    - cron: '0 */1 * * *'  # 매 시간마다 실행

jobs:
  post:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y unzip shadowsocks-libev
        pip install selenium requests beautifulsoup4 webdriver_manager
        
    - name: Setup VPN
      run: |
        echo '{
          "server":"34.64.189.76",
          "server_port":16978,
          "password":"Nsy5l8wxxzHg4CXPKwEw6S",
          "method":"chacha20-ietf-poly1305",
          "local_address":"127.0.0.1",
          "local_port":1080
        }' > ss-config.json
        ss-local -c ss-config.json -v &
        sleep 5
        curl --socks5 127.0.0.1:1080 http://ip-api.com/json
        
    - name: Setup Chrome
      uses: browser-actions/setup-chrome@latest

    - name: Install Chrome and ChromeDriver
      run: |
        # Chrome 설치 및 버전 확인
        wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
        sudo apt install -y ./google-chrome-stable_current_amd64.deb
        rm -f google-chrome-stable_current_amd64.deb
        
        # 정확한 Chrome 버전 추출
        CHROME_VERSION=$(google-chrome --version | awk '{print $3}')
        echo "설치된 Chrome 버전: $CHROME_VERSION"
        
        # ChromeDriver 다운로드 URL 설정
        CHROMEDRIVER_URL="https://storage.googleapis.com/chrome-for-testing-public/${CHROME_VERSION}/linux64/chromedriver-linux64.zip"
        echo "ChromeDriver 다운로드 중: $CHROMEDRIVER_URL"
        
        # ChromeDriver 다운로드 시도
        if ! wget -q "$CHROMEDRIVER_URL" -O chromedriver.zip; then
          echo "첫 번째 URL 실패, 대체 URL 시도..."
          CHROMEDRIVER_URL="https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/${CHROME_VERSION}/linux64/chromedriver-linux64.zip"
          wget -q "$CHROMEDRIVER_URL" -O chromedriver.zip || {
            echo "ChromeDriver 다운로드 실패"
            exit 1
          }
        fi
        
        # 기존 ChromeDriver 제거 및 새 버전 설치
        sudo rm -f /usr/local/bin/chromedriver
        unzip -o chromedriver.zip || {
          echo "ChromeDriver 압축 해제 실패"
          exit 1
        }
        sudo mv chromedriver-linux64/chromedriver /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver
        rm -rf chromedriver.zip chromedriver-linux64
        
        # 버전 확인 및 검증
        echo "설치된 버전 정보:"
        chrome_version=$(google-chrome --version)
        chromedriver_version=$(chromedriver --version)
        echo "Chrome: $chrome_version"
        echo "ChromeDriver: $chromedriver_version"

        # 버전 매칭 확인
        chrome_major=$(echo "$chrome_version" | awk '{print $3}' | cut -d. -f1)
        driver_major=$(echo "$chromedriver_version" | awk '{print $2}' | cut -d. -f1)
        if [ "$chrome_major" != "$driver_major" ]; then
          echo "버전 불일치: Chrome ($chrome_major) != ChromeDriver ($driver_major)"
          exit 1
        fi

    - name: Install Specific Chrome Version
      run: |
        CHROME_VERSION="132.0.6263.0-1"
        echo "Chrome $CHROME_VERSION 설치 중..."
        wget -q "https://dl.google.com/linux/chrome/deb/pool/main/g/google-chrome-stable/google-chrome-stable_${CHROME_VERSION}_amd64.deb"
        sudo apt-get install -y "./google-chrome-stable_${CHROME_VERSION}_amd64.deb"
        rm "google-chrome-stable_${CHROME_VERSION}_amd64.deb"
        
        # 버전 확인
        installed_version=$(google-chrome --version)
        echo "설치된 Chrome 버전: $installed_version"

    - name: Install Matching ChromeDriver
      run: |
        # Chrome 버전에서 정확한 버전 추출
        CHROME_VERSION=$(google-chrome --version | awk '{print $3}' | cut -d. -f1-3)
        echo "Chrome 버전: $CHROME_VERSION"
        
        # ChromeDriver 다운로드 URL 설정
        CHROMEDRIVER_VERSION="132.0.6263.0"  # Chrome 버전과 정확히 일치
        DOWNLOAD_URL="https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/${CHROMEDRIVER_VERSION}/linux64/chromedriver-linux64.zip"
        
        echo "ChromeDriver 다운로드 중... (버전: $CHROMEDRIVER_VERSION)"
        wget -q "$DOWNLOAD_URL" -O chromedriver.zip
        
        # 기존 ChromeDriver 제거 및 새 버전 설치
        sudo rm -f /usr/local/bin/chromedriver
        unzip -o chromedriver.zip
        sudo mv chromedriver-linux64/chromedriver /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver
        rm -rf chromedriver.zip chromedriver-linux64
        
        # 설치 확인
        echo "ChromeDriver 설치됨:"
        chromedriver --version

    - name: Check Chrome and Chromedriver Version
      run: |
        # Chrome 버전 확인 (오류 처리 추가)
        if ! chrome_version=$(google-chrome --version 2>/dev/null); then
          echo "Chrome 버전 확인 실패, 다른 방법 시도..."
          chrome_version=$(google-chrome-stable --version 2>/dev/null || chromium-browser --version 2>/dev/null)
        fi
        
        if [ -z "$chrome_version" ]; then
          echo "Chrome 버전을 확인할 수 없습니다."
          exit 1
        fi
        
        echo "감지된 Chrome 버전: $chrome_version"
        CHROME_VERSION=$(echo "$chrome_version" | awk '{print $NF}' | cut -d'.' -f1)
        echo "추출된 메이저 버전: $CHROME_VERSION"

    - name: Download and Install Correct ChromeDriver
      run: |
        # Chrome 버전 확인 및 정제
        CHROME_VERSION=$(google-chrome --version | awk '{print $3}' | cut -d'.' -f1-3)
        if [ -z "$CHROME_VERSION" ]; then
          echo "Chrome 버전 확인 실패"
          exit 1
        fi
        echo "감지된 Chrome 버전: $CHROME_VERSION"
        
        # ChromeDriver 버전 확인
        LATEST_DRIVER_VERSION=$(curl -s "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_${CHROME_VERSION}")
        if [ -z "$LATEST_DRIVER_VERSION" ]; then
          echo "ChromeDriver 버전 확인 실패, 기본 최신 버전 사용"
          LATEST_DRIVER_VERSION=$(curl -s "https://chromedriver.storage.googleapis.com/LATEST_RELEASE")
        fi
        echo "설치할 ChromeDriver 버전: $LATEST_DRIVER_VERSION"
        
        # 기존 ChromeDriver 제거
        sudo rm -f /usr/local/bin/chromedriver
        sudo rm -f /usr/bin/chromedriver
        
        # ChromeDriver 다운로드 및 설치
        echo "ChromeDriver 다운로드 중..."
        wget -q "https://chromedriver.storage.googleapis.com/$LATEST_DRIVER_VERSION/chromedriver_linux64.zip"
        
        # 압축 해제 및 설치
        echo "ChromeDriver 설치 중..."
        unzip -o chromedriver_linux64.zip
        sudo mv chromedriver /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver
        rm chromedriver_linux64.zip
        
        # 설치 확인
        echo "ChromeDriver 설치 완료"
        chromedriver --version

    - name: Download Chrome Profile
      run: |
        echo "Chrome 프로필 다운로드 중..."
        wget https://github.com/sd2624/qqqq071026242/raw/master/chrome_profile.zip -O chrome_profile.zip
        
        if [ ! -f "chrome_profile.zip" ]; then
          echo "프로필 다운로드 실패"
          exit 1
        fi
        
        echo "프로필 다운로드 완료"
        ls -la chrome_profile.zip
        
    - name: Check Profile Archive
      run: |
        if [ ! -f "chrome_profile.zip" ]; then
          echo "chrome_profile.zip not found!"
          exit 1
        fi
        echo "Found chrome_profile.zip"
        
    - name: Clean Chrome Processes
      run: |
        # 기존 Chrome 프로세스 강제 종료
        echo "기존 Chrome 프로세스 정리 중..."
        pgrep -x "chrome" && pkill -9 "chrome"
        pgrep -x "chromedriver" && pkill -9 "chromedriver"
        sleep 2

    - name: Kill existing Chrome processes
      run: pkill -9 chrome || true
      
    - name: Extract Chrome Profile
      run: |
        unzip chrome_profile.zip -d chrome-profile
        chmod -R 777 chrome-profile
        echo "CHROME_PROFILE_DIR=$(pwd)/chrome-profile" >> $GITHUB_ENV
        ls -la chrome-profile/Default/

    - name: Start Xvfb
      run: Xvfb :99 -screen 0 1920x1080x24 &

    - name: Set Display
      run: echo "DISPLAY=:99" >> $GITHUB_ENV

    - name: Setup Chrome Profile
      run: |
        # 고유한 프로필 디렉토리 설정
        PROFILE_DIR="/tmp/chrome-profile-${GITHUB_RUN_ID}"
        echo "프로필 디렉토리: $PROFILE_DIR"
        
        # 기존 프로필 완전 제거
        sudo rm -rf "$PROFILE_DIR"
        mkdir -p "$PROFILE_DIR/Default"
        
        # 프로필 압축 해제
        echo "프로필 설정 중..."
        unzip -o chrome_profile.zip -d "$PROFILE_DIR" || {
          echo "프로필 압축 해제 실패"
          exit 1
        }
        
        # 권한 설정
        sudo chown -R runner:docker "$PROFILE_DIR"
        chmod -R 755 "$PROFILE_DIR"
        
        # 초기 디렉토리 구조 설정
        for dir in "Cache" "Local Storage" "Session Storage" "Network" "Extension State"; do
          mkdir -p "$PROFILE_DIR/Default/$dir"
          chmod 755 "$PROFILE_DIR/Default/$dir"
        done
        
        # 환경 변수 설정
        {
          echo "CHROME_PROFILE_DIR=$PROFILE_DIR"
          echo "CHROME_BIN=/usr/bin/google-chrome-stable"
        } >> $GITHUB_ENV
        
        echo "프로필 구조:"
        ls -la "$PROFILE_DIR/Default/"

    - name: Configure Chrome Profile
      run: |
        PROFILE_DIR="${CHROME_PROFILE_DIR}"
        
        # 필수 파일 확인
        required_files=("Preferences" "Cookies" "Login Data")
        for file in "${required_files[@]}"; do
          if [ ! -f "$PROFILE_DIR/Default/$file" ]; then
            echo "생성: $file"
            touch "$PROFILE_DIR/Default/$file"
            chmod 644 "$PROFILE_DIR/Default/$file"
          fi
        done
        
        # 중요 디렉토리 권한 설정
        for dir in "Cache" "Local Storage" "Session Storage" "Network"; do
          dir_path="$PROFILE_DIR/Default/$dir"
          if [ -d "$dir_path" ]; then
            find "$dir_path" -type d -exec chmod 755 {} \;
            find "$dir_path" -type f -exec chmod 644 {} \;
          fi
        done
        
        echo "프로필 구성 완료:"
        ls -la "$PROFILE_DIR/Default/"

    - name: Check and Setup Required Directories
      run: |
        # 프로필 디렉토리 확인
        PROFILE_DIR="${CHROME_PROFILE_DIR}"
        echo "프로필 디렉토리: $PROFILE_DIR"
        
        # 캐시 디렉토리 초기화
        rm -rf "$PROFILE_DIR/Default/Cache"/*
        mkdir -p "$PROFILE_DIR/Default/Cache"
        
        # 필수 디렉토리 생성
        for dir in "Local Storage" "Session Storage" "Network"; do
          mkdir -p "$PROFILE_DIR/Default/$dir"
          chmod 755 "$PROFILE_DIR/Default/$dir"
        done
        
        # 프로필 구조 확인
        echo "프로필 구조 확인:"
        ls -la "$PROFILE_DIR/Default/"

    - name: Check Directory Structure
      run: |
        pwd
        echo "현재 작업 디렉토리 구조:"
        ls -la

    - name: Run Auto Posting
      env:
        CHROME_PROFILE_PATH: ${CHROME_PROFILE_DIR}
        XDG_CONFIG_HOME: ${CHROME_PROFILE_DIR}
        DISPLAY: :99
        ALL_PROXY: "socks5://127.0.0.1:1080"
        CHROME_REMOTE_DEBUGGING_PORT: "9222"
        PYTHONUNBUFFERED: 1
        TZ: "Asia/Seoul"
      run: |
        export CHROME_OPTIONS="
          --user-data-dir=${CHROME_PROFILE_DIR}
          --profile-directory=Default
          --no-sandbox
          --disable-dev-shm-usage
          --password-store=basic
          --disable-gpu
          --disable-software-rasterizer
        "
        
        # Chrome 옵션 최소화
        export CHROME_OPTIONS="
          --user-data-dir=${CHROME_PROFILE_DIR}
          --profile-directory=Default
          --no-sandbox
          --disable-dev-shm-usage
          --disable-gpu
          --password-store=basic
          --disable-background-networking
          --disable-default-apps
          --disable-sync
          --no-first-run
        "
        
        # 프로필 디버그
        echo "Chrome 프로필 위치: ${CHROME_PROFILE_DIR}"
        ls -la ${CHROME_PROFILE_DIR}/Default/
        
        echo -e "\n\033[1;36m=== 밴드 자동 포스팅 시작 ===\033[0m"
        echo -e "\033[1;33m현재 시각: $(date '+%Y-%m-%d %H:%M:%S')\033[0m"
        echo -e "\033[1;36m======================================\033[0m\n"
        
        # 로그 파일 초기화 및 실시간 모니터링
        {
          echo "작업 시작 시간: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "======================================="
          echo "1단계: 로그인 프로세스 시작"
          echo "======================================="
        } > band_auto.log
        
        # 스크립트 실행 및 실시간 로그 출력
        PYTHONUNBUFFERED=1 python auto_band_action.py 2>&1 | while IFS= read -r line; do
          timestamp=$(date '+%Y-%m-%d %H:%M:%S')
          
          # 로그인 관련 메시지 우선 처리
          case "$line" in
            *"driver.get("*|*"이동:"*|*"URL:"*)
              echo -e "\n\033[1;35m🌐 페이지 이동\033[0m"
              echo "[$timestamp] 현재 URL: ${line#*\'}"  # URL 부분만 추출
              echo "----------------------------------------"
              ;;
              
            *"밴드로 이동"*|*"URL 주소:"*)
              echo -e "\n\033[1;36m🔄 페이지 전환\033[0m"
              echo "[$timestamp] $line"
              echo "현재 작업: 밴드 페이지 로딩"
              echo "----------------------------------------"
              ;;
              
            *"로그인 시작"*|*"로그인 시도"*)
              echo -e "\n\033[1;34m🔐 로그인 프로세스 시작\033[0m"
              echo "[$timestamp] $line"
              ;;
            
            *"이메일 입력"*|*"비밀번호 입력"*)
              echo -e "\033[1;33m⌨️  $line\033[0m"
              echo "[$timestamp] $line"
              ;;
            
            *"로그인 성공"*)
              echo -e "\033[1;32m✅ 로그인 성공!\033[0m"
              echo "[$timestamp] $line"
              echo "----------------------------------------"
              ;;
              
            *"VPN 상태"*|*"현재 IP"*)
              echo -e "\033[1;36m🌐 $line\033[0m"
              echo "[$timestamp] $line"
              ;;
              
            *"로그인 시작"*)
              echo ""
              echo "🔵 ========= 로그인 프로세스 시작 ========="
              echo "[$timestamp] $line"
              echo "현재 단계: 로그인 페이지 접속 시도"
              ;;
              
            *"로그인 페이지 이동"*)
              echo "[$timestamp] ✓ 로그인 페이지 접속 완료"
              echo "현재 단계: 이메일 로그인 버튼 찾는 중"
              ;;
              
            *"이메일 로그인 버튼"*)
              echo "[$timestamp] ✓ 이메일 로그인 버튼 발견"
              echo "현재 단계: 이메일 입력 준비"
              ;;
              
            *"이메일 입력 완료"*)
              echo "[$timestamp] ✓ 이메일 입력 완료"
              echo "현재 단계: 다음 버튼 클릭"
              ;;
              
            *"다음 버튼 클릭"*)
              echo "[$timestamp] ✓ 다음 단계로 이동"
              echo "현재 단계: 비밀번호 입력 준비"
              ;;
              
            *"비밀번호 입력"*)
              echo "[$timestamp] 🔑 비밀번호 입력 중..."
              ;;
              
            *"비밀번호 입력 완료"*)
              echo "[$timestamp] ✓ 비밀번호 입력 완료"
              echo "현재 단계: 로그인 버튼 클릭"
              ;;
              
            *"로그인 버튼 클릭"*)
              echo "[$timestamp] 🔄 로그인 시도 중..."
              ;;
              
            *"로그인 성공"*)
              echo "[$timestamp] ✅ 로그인 성공!"
              echo "========= 로그인 프로세스 완료 ========="
              echo ""
              ;;
              
            *"로그인 실패"*|*"오류"*)
              echo "[$timestamp] ❌ 로그인 실패!"
              echo "에러 내용: $line"
              echo "========= 로그인 프로세스 실패 ========="
              echo ""
              ;;
              
            *"현재 작업 중인 URL"*)
              echo "🔗 ======= URL 작업 정보 ========"
              echo "[$timestamp] $line"
              ;;
              
            *"밴드로 이동"*|*"URL 주소:"*)
              echo "🌐 현재 페이지 이동"
              echo "[$timestamp] $line"
              ;;
              
            *"글쓰기 버튼"*)
              echo "📝 포스팅 작성 시작"
              echo "[$timestamp] $line"
              ;;
              
            *"URL 입력 중"*)
              echo "⌨️ URL 입력"
              echo "[$timestamp] $line"
              ;;
              
            *"미리보기 로딩"*)
              echo "⏳ 미리보기 로딩"
              echo "[$timestamp] $line"
              ;;
              
            *"포스팅 완료"*)
              echo "✅ ======= 포스팅 완료 ========"
              echo "[$timestamp] $line"
              echo "================================"
              ;;
              
            *"실패"*|*"오류"*)
              echo "❌ ======= 오류 발생 ========"
              echo "[$timestamp] $line"
              echo "=============================="
              ;;
              
            *"대기 시작"*|*"남은 시간"*)
              echo "⏰ 대기 상태"
              echo "[$timestamp] $line"
              ;;
              
            *)
              echo "[$timestamp] $line"
              ;;
          esac
          
          # URL 패턴 감지 및 로깅
          if [[ "$line" =~ https?:// ]]; then
            echo -e "\033[1;34m🔗 접속 URL: $line\033[0m"
          fi
          
          echo "[$timestamp] $line" >> band_auto.log
          
        done

        echo -e "\n=== 실행 통계 생성 ==="
        {
          echo "1. 로그인 프로세스"
          echo "- 시도 횟수: $(grep -c "로그인 시작" band_auto.log)"
          echo "- 성공 횟수: $(grep -c "로그인 성공" band_auto.log)"
          
          echo -e "\n2. URL 작업 현황"
          echo "- 처리된 URL 수: $(grep -c "현재 작업 중인 URL" band_auto.log)"
          echo "- 페이지 이동 수: $(grep -c "밴드로 이동" band_auto.log)"
          
          echo -e "\n3. 포스팅 통계"
          echo "- 글쓰기 시도: $(grep -c "글쓰기 버튼" band_auto.log)"
          echo "- 포스팅 성공: $(grep -c "포스팅 완료" band_auto.log)"
          echo "- 실패/오류: $(grep -c "실패\|오류" band_auto.log)"
          
          echo -e "\n4. 상세 URL 기록"
          echo "처리된 URL 목록:"
          grep "URL 주소:" band_auto.log
          
          echo -e "\n5. 마지막 작업 상태"
          tail -n 20 band_auto.log
          
        } | tee execution_summary.txt

