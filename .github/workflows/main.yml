name: Band Auto Posting

on:
  workflow_dispatch:  # 수동 실행 가능
  schedule:
    - cron: '0 */1 * * *'  # 매 시간마다 실행

jobs:
  post:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y unzip shadowsocks-libev
        pip install selenium requests beautifulsoup4 webdriver_manager
        
    - name: Setup VPN
      run: |
        echo '{
          "server":"34.64.189.76",
          "server_port":16978,
          "password":"Nsy5l8wxxzHg4CXPKwEw6S",
          "method":"chacha20-ietf-poly1305",
          "local_address":"127.0.0.1",
          "local_port":1080
        }' > ss-config.json
        ss-local -c ss-config.json -v &
        sleep 5
        curl --socks5 127.0.0.1:1080 http://ip-api.com/json
        
    - name: Setup Chrome
      uses: browser-actions/setup-chrome@latest
      
    - name: Check Directory Structure
      run: |
        pwd
        echo "현재 작업 디렉토리 구조:"
        ls -la
        
    - name: Extract Chrome Profile
      run: |
        echo "Chrome 프로필 압축 해제 중..."
        mkdir -p chrome-profile
        unzip -o "chrome_profile.zip" -d ./chrome-profile || {
          echo "chrome_profile.zip 파일을 찾을 수 없습니다."
          echo "현재 폴더 내용:"
          ls -la
          exit 1
        }
        echo "Chrome 프로필 압축 해제 완료"
        
    - name: Run Auto Posting
      run: |
        echo "=== 밴드 자동 포스팅 시작 ==="
        
        echo "1. VPN 상태 확인"
        curl --socks5 127.0.0.1:1080 http://ip-api.com/json
        
        echo -e "\n2. Chrome 프로필 확인"
        if [ -d "./chrome-profile" ]; then
          echo "Chrome 프로필 폴더 존재: O"
          echo "프로필 크기:"
          du -sh ./chrome-profile
          echo "프로필 내용:"
          ls -la ./chrome-profile
        else
          echo "Chrome 프로필 폴더 없음"
          exit 1
        fi
        
        echo -e "\n3. 로그인 정보 확인"
        if [ -f "config.json" ]; then
          echo "설정 파일 존재: O"
          echo "이메일 정보:"
          grep -o '"email": "[^"]*"' config.json || echo "이메일 정보 없음"
        else
          echo "설정 파일 없음"
          exit 1
        fi
        
        echo -e "\n4. 자동화 시작"
        python auto_band_action.py 2>&1 | tee band_auto.log
        
        echo -e "\n5. 실행 결과"
        if [ -f "band_auto.log" ]; then
          echo "=== 로그 내용 ==="
          grep -E "로그인|페이지|밴드" band_auto.log || echo "관련 로그 없음"
        fi
      env:
        CHROME_PROFILE_PATH: "./chrome-profile"
        ALL_PROXY: "socks5://127.0.0.1:1080"
        PYTHONUNBUFFERED: 1  # Python 로그 즉시 출력
