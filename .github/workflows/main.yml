name: Band Auto Posting

on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  schedule:
    - cron: '0 */1 * * *'  # ë§¤ ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰

jobs:
  post:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Configure Network Settings
      run: |
        # DNS ì„¤ì •
        echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf > /dev/null
        echo "nameserver 8.8.4.4" | sudo tee -a /etc/resolv.conf > /dev/null
        
        # ë„¤íŠ¸ì›Œí¬ ì„¤ì •
        sudo sysctl -w \
          net.ipv4.tcp_keepalive_time=60 \
          net.ipv4.tcp_keepalive_intvl=60 \
          net.ipv4.tcp_keepalive_probes=5 \
          net.core.rmem_max=2500000 \
          net.core.wmem_max=2500000
        
        # ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ì œí•œ ì„¤ì •
        sudo sysctl -w \
          fs.inotify.max_user_watches=655360 \
          fs.inotify.max_user_instances=1280 \
          vm.max_map_count=262144
          
        # í”„ë¡ì‹œ í™˜ê²½ë³€ìˆ˜ ì´ˆê¸°í™”
        unset http_proxy https_proxy HTTP_PROXY HTTPS_PROXY

    - name: Install dependencies
      run: |
        sudo apt-get update
        # proxychains-ng ì¶”ê°€
        sudo apt-get install -y unzip shadowsocks-libev curl wget xvfb xsel xclip proxychains-ng
        pip install selenium requests beautifulsoup4 webdriver_manager pyperclip

    - name: Configure ProxyChains
      run: |
        # ProxyChains ì„¤ì •
        sudo tee /etc/proxychains4.conf > /dev/null << EOF
        strict_chain
        quiet_mode
        proxy_dns
        remote_dns_subnet 224
        tcp_read_time_out 15000
        tcp_connect_time_out 8000
        [ProxyList]
        socks5 127.0.0.1 1080
        EOF
        
        # ProxyChains í…ŒìŠ¤íŠ¸
        proxychains4 curl -s https://api.ipify.org
        proxychains4 curl -s http://ip-api.com/json

    - name: Setup Shadowsocks
      run: |
        # Shadowsocks ì„¤ì • íŒŒì¼ ìƒì„±
        sudo mkdir -p /etc/shadowsocks-libev
        sudo tee /etc/shadowsocks-libev/config.json > /dev/null << EOF
        {
          "server": "34.64.189.76",
          "server_port": 16978,
          "password": "Nsy5l8wxxzHg4CXPKwEw6S",
          "method": "chacha20-ietf-poly1305",
          "mode": "tcp_and_udp",
          "local_address": "127.0.0.1",
          "local_port": 1080,
          "fast_open": true
        }
        EOF
        
        # Shadowsocks ì„œë¹„ìŠ¤ ì‹œìž‘
        sudo systemctl start shadowsocks-libev-local@config
        sleep 5
        
        # ì‹¤í–‰ í™•ì¸
        systemctl status shadowsocks-libev-local@config --no-pager
        ss -tulpn | grep 1080
        
        # í”„ë¡ì‹œ ì—°ê²° í…ŒìŠ¤íŠ¸
        curl -x socks5h://127.0.0.1:1080 http://ip-api.com/json

    - name: Check VPN process
      run: |
        ps aux | grep sslocal
        echo "í˜„ìž¬ Shadowsocks í”„ë¡œì„¸ìŠ¤ ìƒíƒœ:"
        ss -tulpn | grep 1080 || true

    - name: Restart Shadowsocks Client
      run: |
        # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
        pkill -f sslocal || true
        sleep 2
        
        # ì§ì ‘ ì‹¤í–‰ìœ¼ë¡œ ìž¬ì‹œìž‘
        nohup sslocal -s 34.64.189.76 -p 16978 -k "Nsy5l8wxxzHg4CXPKwEw6S" -m chacha20-ietf-poly1305 -l 1080 --udp-relay &
        sleep 5
        
        # í”„ë¡ì‹œ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
        export HTTPS_PROXY=socks5h://127.0.0.1:1080
        export HTTP_PROXY=socks5h://127.0.0.1:1080
        echo "HTTPS_PROXY=socks5h://127.0.0.1:1080" >> $GITHUB_ENV
        echo "HTTP_PROXY=socks5h://127.0.0.1:1080" >> $GITHUB_ENV
        
        # ì—°ê²° í™•ì¸
        curl -x socks5h://127.0.0.1:1080 http://ip-api.com/json

    - name: Setup Chrome
      run: |
        echo "Installing Chrome directly..."
        wget -q -O /tmp/chrome.deb https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
        sudo apt-get install -y /tmp/chrome.deb
        rm /tmp/chrome.deb
        
        # ì„¤ì¹˜ í™•ì¸
        google-chrome --version
        which google-chrome
        
        # Chrome ì‹¤í–‰ ì˜µì…˜ ì¶”ê°€
        echo "CHROME_OPTS=\
          --disable-web-security \
          --use-fake-ui-for-media-stream \
          --disable-features=IsolateOrigins,site-per-process \
          --ignore-certificate-errors \
          --disable-site-isolation-trials \
          --no-sandbox \
          --disable-dev-shm-usage \
          --disable-gpu \
          --disable-software-rasterizer \
          --disable-background-networking \
          --disable-default-apps \
          --disable-extensions \
          --disable-sync \
          --disable-translate \
          --metrics-recording-only \
          --mute-audio \
          --no-first-run" >> $GITHUB_ENV

    - name: Configure Network Settings
      run: |
        # Proxy configuration
        echo "Setting up proxy configuration..."
        
        # SOCKS proxy settings
        echo "
        {
          \"rules\": {
            \"fallbackProxy\": {
              \"scheme\": \"socks5\",
              \"host\": \"127.0.0.1\",
              \"port\": 1080
            }
          },
          \"mode\": \"fixed_servers\"
        }" > proxy.json
        
        # Set system proxy
        export ALL_PROXY=socks5://127.0.0.1:1080
        export HTTPS_PROXY=socks5h://127.0.0.1:1080
        export HTTP_PROXY=socks5h://127.0.0.1:1080
        
        # Network tuning
        sudo sysctl -w \
          net.ipv4.tcp_keepalive_time=30 \
          net.ipv4.tcp_keepalive_intvl=5 \
          net.ipv4.tcp_keepalive_probes=3 \
          net.ipv4.tcp_fin_timeout=10 \
          net.ipv4.tcp_retries2=5
        
        # Connection test with retry
        for i in {1..5}; do
          echo "Connection test attempt $i..."
          if curl -x socks5h://127.0.0.1:1080 -m 10 https://www.google.com > /dev/null 2>&1; then
            echo "Connection test successful!"
            break
          else
            echo "Connection test failed, retrying in 5 seconds..."
            sleep 5
          fi
        done

    - name: Verify Chrome Installation
      run: |
        if ! command -v google-chrome &> /dev/null; then
          echo "Chrome is not installed. Trying alternative installation..."
          # ëŒ€ì²´ ì„¤ì¹˜ ë°©ë²•
          sudo apt-get update
          sudo apt-get install -y wget
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list'
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
        fi
        
        # ìµœì¢… ì„¤ì¹˜ í™•ì¸
        echo "Installed Chrome version:"
        google-chrome --version
        echo "Chrome binary location:"
        which google-chrome

    - name: Install ChromeDriver
      run: |
        # Chrome ë²„ì „ í™•ì¸
        CHROME_VERSION=$(google-chrome --version | awk '{print $3}')
        CHROME_MAJOR_VERSION=$(echo "$CHROME_VERSION" | cut -d. -f1)
        echo "ì„¤ì¹˜ëœ Chrome ë²„ì „: $CHROME_VERSION"
        
        # Chrome for Testing APIì—ì„œ ë§¤ì¹­ë˜ëŠ” ChromeDriver ì°¾ê¸°
        API_URL="https://googlechromelabs.github.io/chrome-for-testing/known-good-versions-with-downloads.json"
        MATCHING_DRIVER=$(curl -s "$API_URL" | \
          jq -r ".versions[] | 
          select(.version | startswith(\"$CHROME_MAJOR_VERSION.\")) |
          .downloads.chromedriver[] | 
          select(.platform==\"linux64\").url" | head -1)
        
        if [ -z "$MATCHING_DRIVER" ]; then
          echo "í˜¸í™˜ë˜ëŠ” ChromeDriverë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          exit 1
        fi
        
        echo "ë‹¤ìš´ë¡œë“œí•  ChromeDriver URL: $MATCHING_DRIVER"
        
        # ChromeDriver ë‹¤ìš´ë¡œë“œ ë° ì„¤ì¹˜
        wget -q "$MATCHING_DRIVER" -O chromedriver.zip
        unzip -o chromedriver.zip
        sudo mv chromedriver-linux64/chromedriver /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver
        rm -rf chromedriver.zip chromedriver-linux64
        
        # ë²„ì „ í™•ì¸
        echo "=== ì„¤ì¹˜ëœ ë²„ì „ ì •ë³´ ==="
        google-chrome --version
        chromedriver --version

    - name: Download Chrome Profile
      run: |
        echo "Chrome í”„ë¡œí•„ ë‹¤ìš´ë¡œë“œ ì¤‘..."
        wget https://github.com/sd2624/qqqq071026242/raw/master/chrome_profile.zip -O chrome_profile.zip
        
        if [ ! -f "chrome_profile.zip" ]; then
          echo "í”„ë¡œí•„ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨"
          exit 1
        fi
        
        echo "í”„ë¡œí•„ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ"
        ls -la chrome_profile.zip
        
    - name: Check Profile Archive
      run: |
        if [ ! -f "chrome_profile.zip" ]; then
          echo "chrome_profile.zip not found!"
          exit 1
        fi
        echo "Found chrome_profile.zip"
        
    - name: Clean Chrome Processes
      run: |
        # ê¸°ì¡´ Chrome í”„ë¡œì„¸ìŠ¤ ê°•ì œ ì¢…ë£Œ
        echo "ê¸°ì¡´ Chrome í”„ë¡œì„¸ìŠ¤ ì •ë¦¬ ì¤‘..."
        pgrep -x "chrome" && pkill -9 "chrome"
        pgrep -x "chromedriver" && pkill -9 "chromedriver"
        sleep 2

    - name: Kill existing Chrome processes
      run: pkill -9 chrome || true
      
    - name: Extract Chrome Profile
      run: |
        unzip chrome_profile.zip -d chrome-profile
        chmod -R 777 chrome-profile
        echo "CHROME_PROFILE_DIR=$(pwd)/chrome-profile" >> $GITHUB_ENV
        ls -la chrome-profile/Default/

    - name: Start Xvfb
      run: Xvfb :99 -screen 0 1920x1080x24 &

    - name: Set Display
      run: echo "DISPLAY=:99" >> $GITHUB_ENV

    - name: Setup Chrome Profile
      run: |
        # ê³ ìœ í•œ í”„ë¡œí•„ ë””ë ‰í† ë¦¬ ì„¤ì •
        PROFILE_DIR="/tmp/chrome-profile-${GITHUB_RUN_ID}"
        echo "í”„ë¡œí•„ ë””ë ‰í† ë¦¬: $PROFILE_DIR"
        
        # ê¸°ì¡´ í”„ë¡œí•„ ì™„ì „ ì œê±°
        sudo rm -rf "$PROFILE_DIR"
        mkdir -p "$PROFILE_DIR/Default"
        
        # í”„ë¡œí•„ ì••ì¶• í•´ì œ
        echo "í”„ë¡œí•„ ì„¤ì • ì¤‘..."
        unzip -o chrome_profile.zip -d "$PROFILE_DIR" || {
          echo "í”„ë¡œí•„ ì••ì¶• í•´ì œ ì‹¤íŒ¨"
          exit 1
        }
        
        # ê¶Œí•œ ì„¤ì •
        sudo chown -R runner:docker "$PROFILE_DIR"
        chmod -R 755 "$PROFILE_DIR"
        
        # ì´ˆê¸° ë””ë ‰í† ë¦¬ êµ¬ì¡° ì„¤ì •
        for dir in "Cache" "Local Storage" "Session Storage" "Network" "Extension State"; do
          mkdir -p "$PROFILE_DIR/Default/$dir"
          chmod 755 "$PROFILE_DIR/Default/$dir"
        done
        
        # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        {
          echo "CHROME_PROFILE_DIR=$PROFILE_DIR"
          echo "CHROME_BIN=/usr/bin/google-chrome-stable"
        } >> $GITHUB_ENV
        
        echo "í”„ë¡œí•„ êµ¬ì¡°:"
        ls -la "$PROFILE_DIR/Default/"

    - name: Configure Chrome Profile
      run: |
        PROFILE_DIR="${CHROME_PROFILE_DIR}"
        
        # í•„ìˆ˜ íŒŒì¼ í™•ì¸
        required_files=("Preferences" "Cookies" "Login Data")
        for file in "${required_files[@]}"; do
          if [ ! -f "$PROFILE_DIR/Default/$file" ]; then
            echo "ìƒì„±: $file"
            touch "$PROFILE_DIR/Default/$file"
            chmod 644 "$PROFILE_DIR/Default/$file"
          fi
        done
        
        # ì¤‘ìš” ë””ë ‰í† ë¦¬ ê¶Œí•œ ì„¤ì •
        for dir in "Cache" "Local Storage" "Session Storage" "Network"; do
          dir_path="$PROFILE_DIR/Default/$dir"
          if [ -d "$dir_path"]; then
            find "$dir_path" -type d -exec chmod 755 {} \;
            find "$dir_path" -type f -exec chmod 644 {} \;
          fi
        done
        
        echo "í”„ë¡œí•„ êµ¬ì„± ì™„ë£Œ:"
        ls -la "$PROFILE_DIR/Default/"

    - name: Check and Setup Required Directories
      run: |
        # í”„ë¡œí•„ ë””ë ‰í† ë¦¬ í™•ì¸
        PROFILE_DIR="${CHROME_PROFILE_DIR}"
        echo "í”„ë¡œí•„ ë””ë ‰í† ë¦¬: $PROFILE_DIR"
        
        # ìºì‹œ ë””ë ‰í† ë¦¬ ì´ˆê¸°í™”
        rm -rf "$PROFILE_DIR/Default/Cache"/*
        mkdir -p "$PROFILE_DIR/Default/Cache"
        
        # í•„ìˆ˜ ë””ë ‰í† ë¦¬ ìƒì„±
        for dir in "Local Storage" "Session Storage" "Network"; do
          mkdir -p "$PROFILE_DIR/Default/$dir"
          chmod 755 "$PROFILE_DIR/Default/$dir"
        done
        
        # í”„ë¡œí•„ êµ¬ì¡° í™•ì¸
        echo "í”„ë¡œí•„ êµ¬ì¡° í™•ì¸:"
        ls -la "$PROFILE_DIR/Default/"

    - name: Check Directory Structure
      run: |
        pwd
        echo "í˜„ìž¬ ìž‘ì—… ë””ë ‰í† ë¦¬ êµ¬ì¡°:"
        ls -la

    - name: Run Auto Posting
      env:
        CHROME_PROFILE_PATH: ${CHROME_PROFILE_DIR}
        XDG_CONFIG_HOME: ${CHROME_PROFILE_DIR}
        DISPLAY: :99
        ALL_PROXY: "socks5://127.0.0.1:1080"
        HTTPS_PROXY: "socks5h://127.0.0.1:1080"
        HTTP_PROXY: "socks5h://127.0.0.1:1080"
        CHROME_REMOTE_DEBUGGING_PORT: "9222"
        PYTHONUNBUFFERED: 1
        TZ: "Asia/Seoul"
        PROXYCHAINS_CONF_FILE: /etc/proxychains4.conf
      run: |
        # ProxyChains ì„¤ì • í™•ì¸
        cat /etc/proxychains4.conf
        
        # ProxyChains ë””ë²„ê·¸ ëª¨ë“œë¡œ ì‹¤í–‰
        sudo bash -c 'echo "debug_level 1" >> /etc/proxychains4.conf'
        sudo bash -c 'echo "chain_len = 1" >> /etc/proxychains4.conf'
        sudo chmod 644 /etc/proxychains4.conf
        
        # Shadowsocks ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
        sudo systemctl status shadowsocks-libev-local@config --no-pager || true
        
        # í”„ë¡ì‹œ ì—°ê²° í…ŒìŠ¤íŠ¸
        proxychains4 curl -v -x socks5h://127.0.0.1:1080 http://ip-api.com/json || true
        
        # ì§ì ‘ íŒŒì´ì¬ ì‹¤í–‰
        LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libproxychains.so.4 \
        PROXYCHAINS_CONF_FILE=/etc/proxychains4.conf \
        python3 auto_band_action.py

        # Chrome ì˜µì…˜ ì„¤ì •
        export CHROME_OPTIONS="${CHROME_OPTS} \
          --proxy-server=socks5://127.0.0.1:1080 \
          --host-resolver-rules='MAP * ~NOTFOUND , EXCLUDE 127.0.0.1'"
        
        # ProxyChains ê²½ë¡œ í™•ì¸ ë° ì‹¤í–‰
        which proxychains4
        sudo chmod 755 /etc/proxychains4.conf
        
        # ì‹¤í–‰
        sudo -E proxychains4 -f /etc/proxychains4.conf python3 auto_band_action.py

        echo -e "\n\033[1;36m=== ë°´ë“œ ìžë™ í¬ìŠ¤íŒ… ì‹œìž‘ ===\033[0m"
        echo -e "\033[1;33mí˜„ìž¬ ì‹œê°: $(date '+%Y-%m-%d %H:%M:%S')\033[0m"
        echo -e "\033[1;36m======================================\033[0m\n"
        
        # ë¡œê·¸ íŒŒì¼ ì´ˆê¸°í™” ë° ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§
        {
          echo "ìž‘ì—… ì‹œìž‘ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "======================================="
          echo "1ë‹¨ê³„: ë¡œê·¸ì¸ í”„ë¡œì„¸ìŠ¤ ì‹œìž‘"
          echo "======================================="
        } > band_auto.log
        
        # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ë° ì‹¤ì‹œê°„ ë¡œê·¸ ì¶œë ¥
        PYTHONUNBUFFERED=1 python auto_band_action.py 2>&1 | while IFS= read -r line; do
          timestamp=$(date '+%Y-%m-%d %H:%M:%S')
          
          # ë¡œê·¸ì¸ ê´€ë ¨ ë©”ì‹œì§€ ìš°ì„  ì²˜ë¦¬
          case "$line" in
            *"driver.get("*|*"ì´ë™:"*|*"URL:"*)
              echo -e "\n\033[1;35mðŸŒ íŽ˜ì´ì§€ ì´ë™\033[0m"
              echo "[$timestamp] í˜„ìž¬ URL: ${line#*\'}"  # URL ë¶€ë¶„ë§Œ ì¶”ì¶œ
              echo "----------------------------------------"
              ;;
              
            *"ë°´ë“œë¡œ ì´ë™"*|*"URL ì£¼ì†Œ:"*)
              echo -e "\n\033[1;36mðŸ”„ íŽ˜ì´ì§€ ì „í™˜\033[0m"
              echo "[$timestamp] $line"
              echo "í˜„ìž¬ ìž‘ì—…: ë°´ë“œ íŽ˜ì´ì§€ ë¡œë”©"
              echo "----------------------------------------"
              ;;
              
            *"ë¡œê·¸ì¸ ì‹œìž‘"*|*"ë¡œê·¸ì¸ ì‹œë„"*)
              echo -e "\n\033[1;34mðŸ” ë¡œê·¸ì¸ í”„ë¡œì„¸ìŠ¤ ì‹œìž‘\033[0m"
              echo "[$timestamp] $line"
              ;;
            
            *"ì´ë©”ì¼ ìž…ë ¥"*|*"ë¹„ë°€ë²ˆí˜¸ ìž…ë ¥"*)
              echo -e "\033[1;33mâŒ¨ï¸  $line\033[0m"
              echo "[$timestamp] $line"
              ;;
            
            *"ë¡œê·¸ì¸ ì„±ê³µ"*)
              echo -e "\033[1;32mâœ… ë¡œê·¸ì¸ ì„±ê³µ!\033[0m"
              echo "[$timestamp] $line"
              echo "----------------------------------------"
              ;;
              
            *"VPN ìƒíƒœ"*|*"í˜„ìž¬ IP"*)
              echo -e "\033[1;36mðŸŒ $line\033[0m"
              echo "[$timestamp] $line"
              ;;
              
            *"ë¡œê·¸ì¸ ì‹œìž‘"*)
              echo ""
              echo "ðŸ”µ ========= ë¡œê·¸ì¸ í”„ë¡œì„¸ìŠ¤ ì‹œìž‘ ========="
              echo "[$timestamp] $line"
              echo "í˜„ìž¬ ë‹¨ê³„: ë¡œê·¸ì¸ íŽ˜ì´ì§€ ì ‘ì† ì‹œë„"
              ;;
              
            *"ë¡œê·¸ì¸ íŽ˜ì´ì§€ ì´ë™"*)
              echo "[$timestamp] âœ“ ë¡œê·¸ì¸ íŽ˜ì´ì§€ ì ‘ì† ì™„ë£Œ"
              echo "í˜„ìž¬ ë‹¨ê³„: ì´ë©”ì¼ ë¡œê·¸ì¸ ë²„íŠ¼ ì°¾ëŠ” ì¤‘"
              ;;
              
            *"ì´ë©”ì¼ ë¡œê·¸ì¸ ë²„íŠ¼"*)
              echo "[$timestamp] âœ“ ì´ë©”ì¼ ë¡œê·¸ì¸ ë²„íŠ¼ ë°œê²¬"
              echo "í˜„ìž¬ ë‹¨ê³„: ì´ë©”ì¼ ìž…ë ¥ ì¤€ë¹„"
              ;;
              
            *"ì´ë©”ì¼ ìž…ë ¥ ì™„ë£Œ"*)
              echo "[$timestamp] âœ“ ì´ë©”ì¼ ìž…ë ¥ ì™„ë£Œ"
              echo "í˜„ìž¬ ë‹¨ê³„: ë‹¤ìŒ ë²„íŠ¼ í´ë¦­"
              ;;
              
            *"ë‹¤ìŒ ë²„íŠ¼ í´ë¦­"*)
              echo "[$timestamp] âœ“ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™"
              echo "í˜„ìž¬ ë‹¨ê³„: ë¹„ë°€ë²ˆí˜¸ ìž…ë ¥ ì¤€ë¹„"
              ;;
              
            *"ë¹„ë°€ë²ˆí˜¸ ìž…ë ¥"*)
              echo "[$timestamp] ðŸ”‘ ë¹„ë°€ë²ˆí˜¸ ìž…ë ¥ ì¤‘..."
              ;;
              
            *"ë¹„ë°€ë²ˆí˜¸ ìž…ë ¥ ì™„ë£Œ"*)
              echo "[$timestamp] âœ“ ë¹„ë°€ë²ˆí˜¸ ìž…ë ¥ ì™„ë£Œ"
              echo "í˜„ìž¬ ë‹¨ê³„: ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­"
              ;;
              
            *"ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­"*)
              echo "[$timestamp] ðŸ”„ ë¡œê·¸ì¸ ì‹œë„ ì¤‘..."
              ;;
              
            *"ë¡œê·¸ì¸ ì„±ê³µ"*)
              echo "[$timestamp] âœ… ë¡œê·¸ì¸ ì„±ê³µ!"
              echo "========= ë¡œê·¸ì¸ í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ ========="
              echo ""
              ;;
              
            *"ë¡œê·¸ì¸ ì‹¤íŒ¨"*|*"ì˜¤ë¥˜"*)
              echo "[$timestamp] âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨!"
              echo "ì—ëŸ¬ ë‚´ìš©: $line"
              echo "========= ë¡œê·¸ì¸ í”„ë¡œì„¸ìŠ¤ ì‹¤íŒ¨ ========="
              echo ""
              ;;
              
            *"í˜„ìž¬ ìž‘ì—… ì¤‘ì¸ URL"*)
              echo "ðŸ”— ======= URL ìž‘ì—… ì •ë³´ ========"
              echo "[$timestamp] $line"
              ;;
              
            *"ë°´ë“œë¡œ ì´ë™"*|*"URL ì£¼ì†Œ:"*)
              echo "ðŸŒ í˜„ìž¬ íŽ˜ì´ì§€ ì´ë™"
              echo "[$timestamp] $line"
              ;;
              
            *"ê¸€ì“°ê¸° ë²„íŠ¼"*)
              echo "ðŸ“ í¬ìŠ¤íŒ… ìž‘ì„± ì‹œìž‘"
              echo "[$timestamp] $line"
              ;;
              
            *"URL ìž…ë ¥ ì¤‘"*)
              echo "âŒ¨ï¸ URL ìž…ë ¥"
              echo "[$timestamp] $line"
              ;;
              
            *"ë¯¸ë¦¬ë³´ê¸° ë¡œë”©"*)
              echo "â³ ë¯¸ë¦¬ë³´ê¸° ë¡œë”©"
              echo "[$timestamp] $line"
              ;;
              
            *"í¬ìŠ¤íŒ… ì™„ë£Œ"*)
              echo "âœ… ======= í¬ìŠ¤íŒ… ì™„ë£Œ ========"
              echo "[$timestamp] $line"
              echo "================================"
              ;;
              
            *"ì‹¤íŒ¨"*|*"ì˜¤ë¥˜"*)
              echo "âŒ ======= ì˜¤ë¥˜ ë°œìƒ ========"
              echo "[$timestamp] $line"
              echo "=============================="
              ;;
              
            *"ëŒ€ê¸° ì‹œìž‘"*|*"ë‚¨ì€ ì‹œê°„"*)
              echo "â° ëŒ€ê¸° ìƒíƒœ"
              echo "[$timestamp] $line"
              ;;
              
            *)
              echo "[$timestamp] $line"
              ;;
          esac
          
          # URL íŒ¨í„´ ê°ì§€ ë° ë¡œê¹…
          if [[ "$line" =~ https?:// ]]; then
            echo -e "\033[1;34mðŸ”— ì ‘ì† URL: $line\033[0m"
          fi
          
          echo "[$timestamp] $line" >> band_auto.log
          
        done

        echo -e "\n=== ì‹¤í–‰ í†µê³„ ìƒì„± ==="
        {
          echo "1. ë¡œê·¸ì¸ í”„ë¡œì„¸ìŠ¤"
          echo "- ì‹œë„ íšŸìˆ˜: $(grep -c "ë¡œê·¸ì¸ ì‹œìž‘" band_auto.log)"
          echo "- ì„±ê³µ íšŸìˆ˜: $(grep -c "ë¡œê·¸ì¸ ì„±ê³µ" band_auto.log)"
          
          echo -e "\n2. URL ìž‘ì—… í˜„í™©"
          echo "- ì²˜ë¦¬ëœ URL ìˆ˜: $(grep -c "í˜„ìž¬ ìž‘ì—… ì¤‘ì¸ URL" band_auto.log)"
          echo "- íŽ˜ì´ì§€ ì´ë™ ìˆ˜: $(grep -c "ë°´ë“œë¡œ ì´ë™" band_auto.log)"
          
          echo -e "\n3. í¬ìŠ¤íŒ… í†µê³„"
          echo "- ê¸€ì“°ê¸° ì‹œë„: $(grep -c "ê¸€ì“°ê¸° ë²„íŠ¼" band_auto.log)"
          echo "- í¬ìŠ¤íŒ… ì„±ê³µ: $(grep -c "í¬ìŠ¤íŒ… ì™„ë£Œ" band_auto.log)"
          echo "- ì‹¤íŒ¨/ì˜¤ë¥˜: $(grep -c "ì‹¤íŒ¨\|ì˜¤ë¥˜" band_auto.log)"
          
          echo -e "\n4. ìƒì„¸ URL ê¸°ë¡"
          echo "ì²˜ë¦¬ëœ URL ëª©ë¡:"
          grep "URL ì£¼ì†Œ:" band_auto.log
          
          echo -e "\n5. ë§ˆì§€ë§‰ ìž‘ì—… ìƒíƒœ"
          tail -n 20 band_auto.log
          
        } | tee execution_summary.txt

    - name: Configure Network Settings
      run: |
        # í•œêµ­ DNS ì„œë²„ ì„¤ì •
        echo "nameserver 168.126.63.1" | sudo tee /etc/resolv.conf > /dev/null
        echo "nameserver 168.126.63.2" | sudo tee -a /etc/resolv.conf > /dev/null
        
        # ë„¤íŠ¸ì›Œí¬ ë²„í¼ ë° íƒ€ìž„ì•„ì›ƒ ìµœì í™”
        sudo sysctl -w \
          net.core.rmem_max=16777216 \
          net.core.wmem_max=16777216 \
          net.ipv4.tcp_rmem='4096 87380 16777216' \
          net.ipv4.tcp_wmem='4096 65536 16777216' \
          net.ipv4.tcp_fin_timeout=30 \
          net.ipv4.tcp_keepalive_time=120 \
          net.ipv4.tcp_keepalive_intvl=30 \
          net.ipv4.tcp_keepalive_probes=3

    - name: Setup Shadowsocks with ProxyChains
      run: |
        # ProxyChains ì„¤ì¹˜
        sudo apt-get install -y proxychains4
        
        # ProxyChains ì„¤ì •
        sudo tee /etc/proxychains4.conf > /dev/null << EOF
        strict_chain
        proxy_dns
        remote_dns_subnet 224
        tcp_read_time_out 15000
        tcp_connect_time_out 8000
        [ProxyList]
        socks5 127.0.0.1 1080
        EOF
        
        # Shadowsocks ì„¤ì •
        sudo tee /etc/shadowsocks-libev/config.json > /dev/null << EOF
        {
          "server": "34.64.189.76",
          "server_port": 16978,
          "password": "Nsy5l8wxxzHg4CXPKwEw6S",
          "method": "chacha20-ietf-poly1305",
          "mode": "tcp_and_udp",
          "local_address": "127.0.0.1",
          "local_port": 1080,
          "fast_open": true,
          "no_delay": true,
          "reuse_port": true,
          "mptcp": true,
          "mtu": 1500,
          "timeout": 300
        }
        EOF

