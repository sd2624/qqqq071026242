name: Band Auto Posting

on:
  workflow_dispatch:  # 수동 실행 가능
  schedule:
    - cron: '0 */1 * * *'  # 매 시간마다 실행

jobs:
  post:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y unzip shadowsocks-libev
        pip install selenium requests beautifulsoup4 webdriver_manager
        
    - name: Setup VPN
      run: |
        echo '{
          "server":"34.64.189.76",
          "server_port":16978,
          "password":"Nsy5l8wxxzHg4CXPKwEw6S",
          "method":"chacha20-ietf-poly1305",
          "local_address":"127.0.0.1",
          "local_port":1080
        }' > ss-config.json
        ss-local -c ss-config.json -v &
        sleep 5
        curl --socks5 127.0.0.1:1080 http://ip-api.com/json
        
    - name: Setup Chrome
      uses: browser-actions/setup-chrome@latest
      
    - name: Check Directory Structure
      run: |
        pwd
        echo "현재 작업 디렉토리 구조:"
        ls -la
        
    - name: Extract Chrome Profile
      run: |
        echo "Chrome 프로필 압축 해제 중..."
        mkdir -p chrome-profile
        unzip -o "chrome_profile.zip" -d ./chrome-profile || {
          echo "chrome_profile.zip 파일을 찾을 수 없습니다."
          echo "현재 폴더 내용:"
          ls -la
          exit 1
        }
        echo "Chrome 프로필 압축 해제 완료"
        
    - name: Run Auto Posting
      run: |
        echo "=== 밴드 자동 포스팅 시작 ==="
        
        # 실시간 모니터링 스크립트
        PYTHONUNBUFFERED=1 python auto_band_action.py 2>&1 | while IFS= read -r line; do
          timestamp=$(date '+%Y-%m-%d %H:%M:%S')
          
          # 단계별 진행 상황 강조
          case "$line" in
            *"로그인 페이지"*|*"이메일 입력"*|*"비밀번호 입력"*)
              echo "========== 로그인 프로세스 =========="
              echo "[$timestamp] $line"
              echo "===================================="
              ;;
              
            *"현재 URL"*|*"이동 중"*|*"페이지 로딩"*)
              echo "============= URL 이동 =============="
              echo "[$timestamp] $line"
              echo "현재 페이지: $line"
              echo "===================================="
              ;;
              
            *"밴드 목록"*|*"밴드 발견"*|*"총 밴드"*)
              echo "=========== 밴드 목록 수집 =========="
              echo "[$timestamp] $line"
              echo "===================================="
              ;;
              
            *"글쓰기"*|*"URL 입력"*|*"포스팅"*|*"미리보기"*)
              echo "=========== 포스팅 작업 ============"
              echo "[$timestamp] $line"
              echo "===================================="
              ;;
              
            *"성공"*|*"완료"*|*"실패"*|*"오류"*)
              echo "============= 작업 결과 ============="
              echo "[$timestamp] $line"
              echo "===================================="
              ;;
              
            *)
              echo "[$timestamp] $line"
              ;;
          esac
        done

        echo -e "\n=== 실행 결과 요약 ==="
        {
          echo "1. 로그인 단계"
          grep -A 2 "로그인 프로세스" band_auto.log || echo "로그인 기록 없음"
          
          echo -e "\n2. 밴드 목록 수집"
          grep -A 2 "밴드 목록 수집" band_auto.log || echo "밴드 목록 기록 없음"
          
          echo -e "\n3. URL 이동 기록"
          grep "현재 페이지:" band_auto.log || echo "URL 이동 기록 없음"
          
          echo -e "\n4. 포스팅 작업"
          grep -A 1 "포스팅 작업" band_auto.log || echo "포스팅 기록 없음"
          
          echo -e "\n5. 작업 결과"
          echo "성공: $(grep -c "포스팅 완료" band_auto.log)회"
          echo "실패: $(grep -c "실패" band_auto.log)회"
          echo "URL 이동: $(grep -c "현재 페이지:" band_auto.log)회"
          
          echo -e "\n=== 마지막 상태 ==="
          tail -n 10 band_auto.log
        } | tee execution_summary.txt

      env:
        CHROME_PROFILE_PATH: "./chrome-profile"
        ALL_PROXY: "socks5://127.0.0.1:1080"
        PYTHONUNBUFFERED: 1
        TZ: 'Asia/Seoul'
